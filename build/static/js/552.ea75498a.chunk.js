"use strict";(self.webpackChunkswr_concept=self.webpackChunkswr_concept||[]).push([[552],{1552:function(e,n,t){t.r(n),t.d(n,{default:function(){return y}});var s=t(3340),a=t(6959),r=t(2791),i=t(6871),u=t(885),c=t(6308),o=t(4245),d=t(1426),l=t(6403),m=t(2932),f=t(3517),g=t(8835),h=t(1782),v=t(5861),x=t(2982),p=t(7757),j=t.n(p),Z=t(184);function _(e){var n=e.message,t=e.outgoing,s=e.onMount;return(0,r.useEffect)((function(){return s(n)}),[]),(0,Z.jsxs)("div",{className:"message ".concat(t?"message_outgoing":""),children:[n.text,(0,Z.jsxs)("div",{className:"message_status",children:[(0,Z.jsxs)("strong",{children:["sent ",n.createdAt&&"\u2713"]})," ",n.readAt&&(0,Z.jsx)("strong",{children:"read \u2713"})]})]})}function b(e){var n=e.chat,t=(0,g.Z)().user,s=function(e){var n=(0,d.ZP)("/api/messages?".concat(o.stringify(e)),(function(e){return(0,l.Z)("GET",e)})),t=n.data,s=n.isValidating;return{mutate:n.mutate,messages:t,isLoading:s}}({chatId:n.id}),a=s.messages,i=s.isLoading,c=s.mutate,m=n.members.find((function(e){return e.id!==t.id})),p=(0,r.useState)(""),b=(0,u.Z)(p,2),N=b[0],y=b[1];(0,h.Z)("notificationsUpdated",c);var w=function(){var e=(0,v.Z)(j().mark((function e(n){var s;return j().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.from.id===t.id,!n.readAt&&!s){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,(0,l.Z)("PATCH","/api/messages",{id:n.id,readAt:new Date});case 5:c();case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}();return(0,Z.jsxs)("div",{className:"chat",children:[(0,Z.jsxs)(f.Z,{children:["Messages from: ",(0,Z.jsx)("strong",{children:null===m||void 0===m?void 0:m.name}),(0,Z.jsx)("i",{children:!a&&i?" loading...":i?" updating...":null})]}),a&&(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)("div",{className:"message-list",children:a.map((function(e){var n=e.from.id===t.id;return(0,Z.jsx)("div",{className:"message-list__item ".concat(n?"message-list__item_outgoing":""),children:(0,Z.jsx)(_,{message:e,outgoing:n,onMount:w})},e.id)}))}),(0,Z.jsxs)("div",{className:"chat__form",children:[(0,Z.jsxs)("form",{onSubmit:function(e){e.preventDefault();var s={id:100*Math.random(),chatId:n.id,from:t,text:N};(0,l.Z)("POST","/api/messages",s),c([].concat((0,x.Z)(a||[]),[s])),y("")},className:"message-form",children:[(0,Z.jsx)("input",{className:"message-form__input",type:"text",value:N,onChange:function(e){y(e.target.value)}}),(0,Z.jsx)("input",{className:"message-form__button",type:"submit",value:"Send message"})]}),(0,Z.jsx)("div",{style:{marginTop:20},children:(0,Z.jsx)("button",{onClick:function(){(0,l.Z)("POST","/api/messages",{id:100*Math.random(),chatId:n.id,from:m,text:100*Math.random()})},children:"Receive random message"})})]})]})]})}function N(){var e=(0,g.Z)().user,n=function(e){var n=(0,d.ZP)("/api/chats?".concat(o.stringify(e)),(function(e){return(0,l.Z)("GET",e)}));return{chats:n.data,mutate:n.mutate}}({memberIds:[e.id]}),t=n.chats,s=n.mutate,a=(0,r.useState)(null),i=(0,u.Z)(a,2),v=i[0],x=i[1];return(0,h.Z)("notificationsUpdated",s),(0,r.useEffect)((function(){!v&&null!==t&&void 0!==t&&t[0]&&x(t[0])}),[v,t]),(0,Z.jsxs)(m.Z,{children:[(0,Z.jsx)(f.Z,{tag:"h1",children:"Chats"}),(0,Z.jsxs)("div",{className:"messages-page",children:[(0,Z.jsx)("div",{className:"messages-page__list",children:t?t.map((function(n,t){var s=n.members.find((function(n){return n.id!==e.id}));return(0,Z.jsxs)("button",{className:"messages-page__list-item",onClick:function(){return x(n)},children:[null===s||void 0===s?void 0:s.name," ",n.unreadMessageCount?(0,Z.jsx)(c.Z,{children:n.unreadMessageCount}):null]},n.id)})):"Loading..."}),(0,Z.jsx)("div",{className:"messages-page__chat",children:v&&(0,Z.jsx)(b,{chat:v})})]})]})}function y(){return(0,s.Q)().currentAuth.user?(0,Z.jsx)(N,{}):(0,Z.jsx)(i.Fg,{to:a.Z.login()})}},2932:function(e,n,t){t.d(n,{Z:function(){return d}});var s=t(8835),a=t(2791),r=t(8277),i=t(184),u=a.lazy((function(){return t.e(824).then(t.bind(t,8824))})),c=a.lazy((function(){return t.e(615).then(t.bind(t,8615))})),o=a.lazy((function(){return t.e(580).then(t.bind(t,4580))}));function d(e){var n=e.children,t=(0,s.Z)().user,d={client:u,employee:c,owner:o}[t.role];return(0,i.jsx)(a.Suspense,{fallback:(0,i.jsx)(r.Z,{}),children:(0,i.jsx)(d,{children:n})})}},6308:function(e,n,t){t.d(n,{Z:function(){return a}});t(2791);var s=t(184);function a(e){var n=e.children;return(0,s.jsx)("span",{className:"badge",children:n})}},8835:function(e,n,t){t.d(n,{Z:function(){return a}});var s=t(3340);function a(){var e=(0,s.Q)().currentAuth;if(!e.user)throw new Error("User not loaded");return{user:e.user}}},6959:function(e,n,t){var s=t(4245),a=t(6871),r=t(6581)._.reduce((function(e,n){return e[n.id]=function(e){var t=e||{},r=t.params,i=t.query,u=(0,a.Gn)(n.path,r);return i?"".concat(u).concat(s.stringify(i)):u},e}),{});n.Z=r}}]);
//# sourceMappingURL=552.ea75498a.chunk.js.map